<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Discussion Room - {{ blog.title }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-tr from-purple-100 via-gray-50 to-white min-h-screen flex items-center justify-center p-4">

<div class="transition-all duration-500 w-full max-w-4xl bg-white/80 backdrop-blur-lg rounded-3xl shadow-2xl grid grid-cols-1 md:grid-cols-[250px_1fr] overflow-hidden">

  <!-- Sidebar -->
  <aside class="hidden md:flex flex-col bg-purple-700 text-white p-6 space-y-6 justify-between rounded-l-3xl">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full border-2 border-white overflow-hidden bg-white/20 flex justify-center items-center">
        <img src="/static/img/blogb.jpg" alt="BlogBeat" class="object-cover rounded-full w-full h-full" />
      </div>
      <h2 class="text-lg font-bold tracking-wide">BlogBeat</h2>
    </div>

    <!-- User Info -->
    <div class="text-center space-y-2">
      <div class="w-16 h-16 bg-white/20 rounded-full mx-auto flex items-center justify-center text-2xl font-bold">
        {{ user.first_name|default:"U"|slice:":1"|upper }}
      </div>
      <div>
        <h3 class="text-xl font-semibold">{{ user.username }}</h3>
        <p class="text-sm text-purple-200">Logged In User</p>
      </div>
      <p class="text-xs text-purple-100">{{ user.first_name }} {{ user.last_name }}</p>
    </div>

    <div class="text-xs text-purple-200 italic text-center">
      <p>Stay Curious ðŸš€</p>
    </div>
  </aside>

  <!-- Main Chat -->
  <main class="p-5 flex flex-col space-y-4 w-full">
    <div>
      <h1 class="text-2xl font-extrabold text-purple-700 mb-1">BlogBeat Discussion</h1>
      <h2 class="text-xl font-semibold text-purple-700">{{ blog.title }}</h2>
    </div>

    <!-- Chat Box -->
    <section id="chatBox" class="h-[400px] overflow-y-auto bg-gray-50 border border-gray-200 rounded-2xl p-4 space-y-4 shadow-inner scroll-smooth">
      {% for message in messages %}
        {% if message.user == request.user %}
        <div class="flex justify-end">
          <div class="bg-purple-600 text-white max-w-[70%] p-2 px-4 rounded-xl rounded-br-none text-sm shadow-md">
            <p>{{ message.content }}</p>
            <p class="text-[10px] text-purple-200 text-right mt-1">{{ message.timestamp|date:"M d, H:i" }}</p>
          </div>
        </div>
        {% else %}
        <div class="flex items-start space-x-3">
          <div class="w-8 h-8 bg-purple-300 text-white rounded-full flex items-center justify-center text-xs font-bold">
            {{ message.user.username|slice:":1"|upper }}
          </div>
          <div class="bg-white border max-w-[70%] p-2 px-4 rounded-xl rounded-bl-none shadow-sm text-sm">
            <div class="font-medium text-purple-700">{{ message.user.first_name }} {{ message.user.last_name }}</div>
            <div>{{ message.content }}</div>
            <div class="text-[10px] text-gray-400 mt-1">{{ message.timestamp|date:"M d, H:i" }}</div>
          </div>
        </div>
        {% endif %}
      {% empty %}
        <p class="text-center text-gray-400 italic">No messages yet. Be the first to start the conversation!</p>
      {% endfor %}
    </section>

    <!-- Input (realtime sending) -->
    {% if user.is_authenticated %}
    <div class="flex items-center gap-3 mt-4">
      <input id="chat-input" type="text" placeholder="Type your message..." class="flex-1 px-4 py-3 border border-gray-300 rounded-xl shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white" />
      <button id="chat-send-btn" class="bg-purple-700 hover:bg-purple-800 text-white px-5 py-2 rounded-xl font-semibold shadow-md">
        Send
      </button>
    </div>
    {% else %}
    <p class="text-sm text-red-500 text-center">
      Please <a href="{% url 'login' %}" class="underline font-semibold">log in</a> to chat.
    </p>
    {% endif %}
  </main>
</div>

<!-- Auto-scroll + WebSocket Logic -->
<script>
  const chatBox = document.getElementById("chatBox");
  if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;

  {% if user.is_authenticated %}
  const slug = "{{ blog.slug|escapejs }}";
  const user = {
    username: "{{ user.username|escapejs }}",
    first_name: "{{ user.first_name|escapejs }}",
    last_name: "{{ user.last_name|escapejs }}"
  };

  const socket = new WebSocket("ws://" + window.location.host + "/ws/blogchat/" + slug + "/");

  socket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    const messageEl = document.createElement("div");
    const isCurrentUser = data.username === user.username;

    messageEl.innerHTML = isCurrentUser
      ? `<div class="flex justify-end">
          <div class="bg-purple-600 text-white max-w-[70%] p-2 px-4 rounded-xl rounded-br-none text-sm shadow-md">
            <p>${data.message}</p>
            <p class="text-[10px] text-purple-200 text-right mt-1">just now</p>
          </div>
        </div>`
      : `<div class="flex items-start space-x-3">
          <div class="w-8 h-8 bg-purple-300 text-white rounded-full flex items-center justify-center text-xs font-bold">
            ${data.username.charAt(0).toUpperCase()}
          </div>
          <div class="bg-white border max-w-[70%] p-2 px-4 rounded-xl rounded-bl-none shadow-sm text-sm">
            <div class="font-medium text-purple-700">${data.first_name} ${data.last_name}</div>
            <div>${data.message}</div>
            <div class="text-[10px] text-gray-400 mt-1">just now</div>
          </div>
        </div>`;

    chatBox.appendChild(messageEl);
    chatBox.scrollTop = chatBox.scrollHeight;
  };

  document.getElementById("chat-send-btn").addEventListener("click", () => {
    const input = document.getElementById("chat-input");
    const message = input.value.trim();
    if (message.length > 0 && socket.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify({ message }));
      input.value = "";
    }
  });
  {% endif %}
</script>
</body>
</html>
