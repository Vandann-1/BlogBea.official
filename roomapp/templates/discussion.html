<form method="POST" action="" class="flex items-center gap-3 mt-4">
  {% csrf_token %}

  <!-- Hidden file upload -->
  <label for="file-upload" class="cursor-pointer p-3 bg-gray-100 hover:bg-gray-200 rounded-xl shadow-sm">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
    </svg>
    <input type="file" id="file-upload" class="hidden" />
  </label>

  <!-- ‚úÖ Add id="chat-input" -->
  <input id="chat-input" type="text" name="content" placeholder="Type your message..."
         class="flex-1 px-4 py-3 border border-gray-300 rounded-xl shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white"
         required>

  <!-- ‚úÖ Add id="chat-send-btn" -->
  <button id="chat-send-btn" type="button"
          class="bg-purple-700 hover:bg-purple-800 text-white px-5 py-2 rounded-xl font-semibold shadow-md">
    Send
  </button>
</form>

<!-- ‚úÖ Place this before </body> -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const slug = "{{ blog.slug|escapejs }}";
    console.log("üî∑ Chat slug:", slug);

    const chatSocket = new WebSocket("ws://" + window.location.host + "/ws/blogchat/" + slug + "/");

    chatSocket.onopen = () => {
      console.log("‚úÖ WebSocket connected");
    };

    chatSocket.onerror = (e) => console.error("‚ùå WebSocket error", e);
    chatSocket.onclose = (e) => console.warn("‚ö†Ô∏è WebSocket closed", e);

    chatSocket.onmessage = (e) => {
      const data = JSON.parse(e.data);
      console.log("üì• Message:", data);
      const chatBox = document.getElementById("chatBox");
      chatBox.innerHTML += `
        <div class="flex items-start space-x-3">
          <div class="w-8 h-8 bg-purple-300 text-white rounded-full flex items-center justify-center text-xs font-bold">
            ${data.user.charAt(0).toUpperCase()}
          </div>
          <div class="bg-white border max-w-[70%] p-2 px-4 rounded-xl rounded-bl-none shadow-sm text-sm">
            <div class="font-medium text-purple-700">${data.user}</div>
            <div>${data.message}</div>
          </div>
        </div>
      `;
      chatBox.scrollTop = chatBox.scrollHeight;
    };

    // ‚úÖ Get DOM elements safely
    const sendBtn = document.getElementById("chat-send-btn");
    const input = document.getElementById("chat-input");

    if (sendBtn && input) {
      sendBtn.addEventListener("click", function () {
        const message = input.value.trim();
        if (message === "") {
          console.log("‚ö†Ô∏è Empty message");
          return;
        }

        if (chatSocket.readyState === WebSocket.OPEN) {
          chatSocket.send(JSON.stringify({ message }));
          input.value = "";
        } else {
          alert("WebSocket not ready yet.");
        }
      });
    } else {
      console.error("‚ùå Elements not found: chat-send-btn or chat-input");
    }
  });
</script>
