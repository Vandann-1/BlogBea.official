{% load static %}
<div class="flex flex-col md:flex-row max-w-6xl mx-auto min-h-screen mt-10 shadow-md rounded-lg overflow-hidden">
  <!-- Sidebar (Current User Info) -->
  <aside class="md:w-1/3 w-full bg-gradient-to-br from-purple-600 to-indigo-700 text-white p-6">
    <div class="mb-8">
      <div class="flex items-center gap-3 mb-5">
        <div class="bg-white text-black font-bold rounded-full h-10 w-10 flex items-center justify-center">cr</div>
        <h1 class="text-2xl font-semibold">BlogBeat</h1>
      </div>

      <div class="text-center bg-white/10 p-4 rounded-lg">
        <div class="bg-white text-purple-700 w-16 h-16 rounded-full mx-auto flex items-center justify-center text-xl font-bold">
          {{ user.first_name|default:"U"|slice:":1" }}
        </div>
        <h2 class="mt-2 text-lg font-semibold">{{ user.username }}</h2>
        <p class="text-sm">Logged-in User</p>
        <p class="text-xs mt-1 text-gray-300">{{ user.first_name }} {{ user.last_name }}</p>
      </div>
    </div>
    <p class="text-sm opacity-80 italic">Stay Curious ✏️</p>
  </aside>

  <!-- Chat Panel -->
  <section class="flex-1 bg-white p-6 flex flex-col">
    <h2 class="text-2xl font-bold text-purple-700 mb-1">BlogBeat Discussion</h2>
    <p class="text-sm text-gray-500 mb-4">{{ blog.title }}</p>

    <div id="chat-box" class="flex-1 overflow-y-auto bg-gray-50 border rounded-lg p-4 mb-4 h-96 text-sm">
      <p class="text-center text-gray-400">No messages yet. Be the first to start the conversation!</p>
    </div>

    <div class="flex gap-2">
      <input id="chat-input" type="text" placeholder="Type your message..." class="flex-1 px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-purple-400" />
      <button id="chat-send-btn" class="bg-purple-600 text-white px-6 py-2 rounded-full hover:bg-purple-700">Send</button>
    </div>
  </section>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const slug = "{{ blog.slug|escapejs }}";
    const user = {
      username: "{{ user.username|escapejs }}",
      first_name: "{{ user.first_name|escapejs }}",
      last_name: "{{ user.last_name|escapejs }}"
    };

    const chatSocket = new WebSocket("ws://" + window.location.host + "/ws/blogchat/" + slug + "/");

    chatSocket.onopen = () => console.log("✅ WebSocket connected");
    chatSocket.onclose = e => console.warn("⚠️ WebSocket disconnected", e);
    chatSocket.onerror = err => console.error("❌ WebSocket error", err);

    chatSocket.onmessage = e => {
      const data = JSON.parse(e.data);
      const chatBox = document.querySelector("#chat-box");
      const msgEl = document.createElement("div");

      msgEl.className = "mb-2";
      msgEl.innerHTML = `
        <p class="text-sm">
          <span class="text-purple-600 font-semibold">${data.first_name} ${data.last_name}</span>
          <span class="text-gray-400 text-xs">(@${data.username})</span>:
          <span>${data.message}</span>
        </p>
      `;
      chatBox.appendChild(msgEl);
      chatBox.scrollTop = chatBox.scrollHeight;
    };

    document.querySelector("#chat-send-btn").addEventListener("click", () => {
      const input = document.querySelector("#chat-input");
      const message = input.value.trim();
      if (!message) return;

      if (chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({ message }));
        input.value = "";
      } else {
        alert("WebSocket not connected.");
      }
    });
  });
</script>
